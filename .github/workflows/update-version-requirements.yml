name: Update Version Requirements

on:
  # Run every 4 months on the 1st at midnight
  schedule:
    - cron: '0 0 1 */4 *'

  # Allow manual triggering
  workflow_dispatch:
    inputs:
      config_repo:
        description: 'Config repository (owner/repo)'
        required: false
        default: ''
      config_path:
        description: 'Path to config file in repo'
        required: false
        default: 'version-requirements.yml'

jobs:
  update-versions:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get configuration repository
        id: get-config
        run: |
          # Use input if provided, otherwise use repository variable
          CONFIG_REPO="${{ github.event.inputs.config_repo }}"
          CONFIG_PATH="${{ github.event.inputs.config_path }}"

          if [ -z "$CONFIG_REPO" ]; then
            CONFIG_REPO="${{ vars.VERSION_CONFIG_REPO }}"
          fi

          if [ -z "$CONFIG_PATH" ]; then
            CONFIG_PATH="version-requirements.yml"
          fi

          echo "config_repo=$CONFIG_REPO" >> $GITHUB_OUTPUT
          echo "config_path=$CONFIG_PATH" >> $GITHUB_OUTPUT

          if [ -z "$CONFIG_REPO" ]; then
            echo "ERROR: No config repository specified. Set VERSION_CONFIG_REPO variable or provide config_repo input."
            exit 1
          fi

      - name: Download version configuration
        run: |
          CONFIG_REPO="${{ steps.get-config.outputs.config_repo }}"
          CONFIG_PATH="${{ steps.get-config.outputs.config_path }}"

          echo "Fetching configuration from $CONFIG_REPO/$CONFIG_PATH"

          # Download the config file from the main branch of the config repo
          curl -f -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3.raw" \
               -o version-config.yml \
               "https://api.github.com/repos/$CONFIG_REPO/contents/$CONFIG_PATH"

          if [ $? -ne 0 ]; then
            echo "ERROR: Failed to download configuration from $CONFIG_REPO/$CONFIG_PATH"
            exit 1
          fi

          echo "Configuration downloaded successfully"
          cat version-config.yml

      - name: Parse configuration and detect plugin type
        id: parse-config
        run: |
          # Install yq for YAML parsing
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

          # Parse version requirements
          WP_REQUIRES=$(yq eval '.wordpress.requires_at_least' version-config.yml)
          WP_TESTED=$(yq eval '.wordpress.tested_up_to' version-config.yml)
          PHP_REQUIRES=$(yq eval '.php.requires' version-config.yml)
          WC_REQUIRES=$(yq eval '.woocommerce.requires_at_least' version-config.yml)
          WC_TESTED=$(yq eval '.woocommerce.tested_up_to' version-config.yml)

          echo "wp_requires=$WP_REQUIRES" >> $GITHUB_OUTPUT
          echo "wp_tested=$WP_TESTED" >> $GITHUB_OUTPUT
          echo "php_requires=$PHP_REQUIRES" >> $GITHUB_OUTPUT
          echo "wc_requires=$WC_REQUIRES" >> $GITHUB_OUTPUT
          echo "wc_tested=$WC_TESTED" >> $GITHUB_OUTPUT

          # Detect if this is a WooCommerce plugin
          IS_WC_PLUGIN=false

          # Check readme.txt for WooCommerce keywords
          if [ -f readme.txt ]; then
            if grep -i -E "woocommerce|woo commerce|woo-commerce" readme.txt > /dev/null; then
              IS_WC_PLUGIN=true
            fi
          fi

          # Check main plugin file for WooCommerce keywords
          MAIN_FILE=$(find . -maxdepth 1 -name "*.php" -type f | head -n 1)
          if [ -f "$MAIN_FILE" ]; then
            if grep -i -E "woocommerce|woo commerce|woo-commerce" "$MAIN_FILE" > /dev/null; then
              IS_WC_PLUGIN=true
            fi
          fi

          echo "is_wc_plugin=$IS_WC_PLUGIN" >> $GITHUB_OUTPUT
          echo "main_file=$MAIN_FILE" >> $GITHUB_OUTPUT

          echo "Parsed configuration:"
          echo "  WordPress requires: $WP_REQUIRES"
          echo "  WordPress tested: $WP_TESTED"
          echo "  PHP requires: $PHP_REQUIRES"
          echo "  WooCommerce requires: $WC_REQUIRES"
          echo "  WooCommerce tested: $WC_TESTED"
          echo "  Is WooCommerce plugin: $IS_WC_PLUGIN"
          echo "  Main file: $MAIN_FILE"

      - name: Update main plugin file
        run: |
          MAIN_FILE="${{ steps.parse-config.outputs.main_file }}"
          IS_WC_PLUGIN="${{ steps.parse-config.outputs.is_wc_plugin }}"

          if [ ! -f "$MAIN_FILE" ]; then
            echo "ERROR: Main plugin file not found"
            exit 1
          fi

          echo "Updating $MAIN_FILE"

          # Update WordPress requirements
          sed -i "s/^\( \* Requires at least:\s*\).*/\1${{ steps.parse-config.outputs.wp_requires }}/" "$MAIN_FILE"
          sed -i "s/^\( \* Requires PHP:\s*\).*/\1${{ steps.parse-config.outputs.php_requires }}/" "$MAIN_FILE"

          # Update WooCommerce requirements if it's a WC plugin
          if [ "$IS_WC_PLUGIN" = "true" ]; then
            # Check if WC requirements exist, if not add them
            if grep -q "WC requires at least:" "$MAIN_FILE"; then
              sed -i "s/^\( \* WC requires at least:\s*\).*/\1${{ steps.parse-config.outputs.wc_requires }}/" "$MAIN_FILE"
            else
              # Add after Requires PHP line
              sed -i "/^ \* Requires PHP:/a \ * WC requires at least: ${{ steps.parse-config.outputs.wc_requires }}" "$MAIN_FILE"
            fi

            if grep -q "WC tested up to:" "$MAIN_FILE"; then
              sed -i "s/^\( \* WC tested up to:\s*\).*/\1${{ steps.parse-config.outputs.wc_tested }}/" "$MAIN_FILE"
            else
              # Add after WC requires at least line
              sed -i "/^ \* WC requires at least:/a \ * WC tested up to: ${{ steps.parse-config.outputs.wc_tested }}" "$MAIN_FILE"
            fi
          fi

          echo "Updated $MAIN_FILE"

      - name: Update readme.txt
        run: |
          IS_WC_PLUGIN="${{ steps.parse-config.outputs.is_wc_plugin }}"

          if [ ! -f readme.txt ]; then
            echo "readme.txt not found, skipping"
            exit 0
          fi

          echo "Updating readme.txt"

          # Update WordPress requirements
          sed -i "s/^\(Requires at least:\s*\).*/\1${{ steps.parse-config.outputs.wp_requires }}/" readme.txt
          sed -i "s/^\(Tested up to:\s*\).*/\1${{ steps.parse-config.outputs.wp_tested }}/" readme.txt
          sed -i "s/^\(Requires PHP:\s*\).*/\1${{ steps.parse-config.outputs.php_requires }}/" readme.txt

          # Update WooCommerce requirements if it's a WC plugin
          if [ "$IS_WC_PLUGIN" = "true" ]; then
            # Check if WC requirements exist in readme.txt
            if grep -q "WC requires at least:" readme.txt; then
              sed -i "s/^\(WC requires at least:\s*\).*/\1${{ steps.parse-config.outputs.wc_requires }}/" readme.txt
            else
              # Add after Requires PHP line
              sed -i "/^Requires PHP:/a WC requires at least: ${{ steps.parse-config.outputs.wc_requires }}" readme.txt
            fi

            if grep -q "WC tested up to:" readme.txt; then
              sed -i "s/^\(WC tested up to:\s*\).*/\1${{ steps.parse-config.outputs.wc_tested }}/" readme.txt
            else
              # Add after WC requires at least line
              sed -i "/^WC requires at least:/a WC tested up to: ${{ steps.parse-config.outputs.wc_tested }}" readme.txt
            fi
          fi

          echo "Updated readme.txt"

      - name: Check for changes
        id: check-changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git diff
          fi

      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          # Create a new branch
          BRANCH_NAME="update-version-requirements-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"

          # Commit changes
          git add -A
          git commit -m "chore: update version requirements

          Updated version requirements:
          - WordPress requires at least: ${{ steps.parse-config.outputs.wp_requires }}
          - WordPress tested up to: ${{ steps.parse-config.outputs.wp_tested }}
          - PHP requires: ${{ steps.parse-config.outputs.php_requires }}
          - WooCommerce requires at least: ${{ steps.parse-config.outputs.wc_requires }}
          - WooCommerce tested up to: ${{ steps.parse-config.outputs.wc_tested }}

          Source: ${{ steps.get-config.outputs.config_repo }}/${{ steps.get-config.outputs.config_path }}"

          # Push the branch with retry logic
          MAX_RETRIES=4
          RETRY_COUNT=0
          DELAY=2

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if git push -u origin "$BRANCH_NAME"; then
              echo "Successfully pushed to $BRANCH_NAME"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "Push failed, retrying in ${DELAY}s... (Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
                sleep $DELAY
                DELAY=$((DELAY * 2))
              else
                echo "Failed to push after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done

          # Create PR body
          PR_BODY="## Version Requirements Update

          This PR updates the plugin's version requirements based on the centralized configuration.

          ### Changes:
          - **WordPress requires at least:** ${{ steps.parse-config.outputs.wp_requires }}
          - **WordPress tested up to:** ${{ steps.parse-config.outputs.wp_tested }}
          - **PHP requires:** ${{ steps.parse-config.outputs.php_requires }}"

          if [ "${{ steps.parse-config.outputs.is_wc_plugin }}" = "true" ]; then
            PR_BODY="$PR_BODY
          - **WooCommerce requires at least:** ${{ steps.parse-config.outputs.wc_requires }}
          - **WooCommerce tested up to:** ${{ steps.parse-config.outputs.wc_tested }}"
          fi

          PR_BODY="$PR_BODY

          ### Configuration Source:
          \`${{ steps.get-config.outputs.config_repo }}/${{ steps.get-config.outputs.config_path }}\`

          ---
          *This PR was automatically generated by the version requirements update workflow.*"

          # Save PR body to file
          echo "$PR_BODY" > pr-body.txt

          # Create PR using GitHub API
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls" \
            -d "{
              \"title\": \"chore: update version requirements\",
              \"body\": $(jq -Rs . < pr-body.txt),
              \"head\": \"$BRANCH_NAME\",
              \"base\": \"${{ github.event.repository.default_branch }}\"
            }"

          echo "Pull request created successfully"

      - name: No changes
        if: steps.check-changes.outputs.has_changes == 'false'
        run: |
          echo "No version requirement changes needed. All versions are already up to date."
